#!/usr/bin/env bash
set -euo pipefail

# simple build helper for Meson, CMake, or Autotools
# usage:
#   ./build.sh                    # auto-detect, release
#   ./build.sh --debug            # full debug
#   ./build.sh --fastdebug        # optimized+gdb-friendly
#   ./build.sh --asan             # debug + ASan/UBSan
#   ./build.sh --fastasan         # optimized + ASan/UBSan
#   ./build.sh --cmake --fastasan # force CMake, fast ASan
#   ./build.sh --meson --debug
#   ./build.sh --autotools --release

die() {
  echo "Error: $*" >&2
  exit 1
}

usage() {
  cat <<EOF
Usage: $0 [--cmake|--meson|--autotools] [--release|--debug|--fastdebug|--asan|--fastasan]

  --cmake      force CMake build
  --meson      force Meson build
  --autotools  force Autotools build (configure/make)

  --release    optimized release build (default)
  --debug      full debug build (-O0 -g)
  --fastdebug  optimized debug build (-O2 -g1)
  --asan       debug build with AddressSanitizer + UBSan
  --fastasan   optimized build with AddressSanitizer + UBSan

Examples:
  $0
  $0 --debug
  $0 --fastdebug
  $0 --asan
  $0 --fastasan
  $0 --cmake --fastasan
  $0 --meson --debug
  $0 --autotools --release
EOF
}

trap 'echo "Failed: ${BASH_COMMAND}" >&2' ERR

build_system=auto
config=release

while [[ $# -gt 0 ]]; do
  case "$1" in
    --cmake)     build_system=cmake ;;
    --meson)     build_system=meson ;;
    --autotools) build_system=autotools ;;
    --release)   config=release ;;
    --debug)     config=debug ;;
    --fastdebug) config=fastdebug ;;
    --asan)      config=asan ;;
    --fastasan)  config=fastasan ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      die "Unknown argument: $1"
      ;;
  esac
  shift
done

# auto detect build system if not forced, prefer meson then cmake then autotools
if [[ "$build_system" == "auto" ]]; then
  if [[ -f meson.build ]]; then
    build_system=meson
  elif [[ -f CMakeLists.txt ]]; then
    build_system=cmake
  elif [[ -x ./bootstrap || -x ./autogen.sh || -f configure.ac || -f configure.in || -f configure ]]; then
    build_system=autotools
  else
    die "could not detect build system (no meson.build, CMakeLists.txt, bootstrap/autogen, or configure.ac)"
  fi
fi

# default to clang if not already set
: "${CC:=clang}"
: "${CXX:=clang++}"
export CC CXX

if command -v nproc >/dev/null 2>&1; then
  NPROC="$(nproc)"
else
  NPROC=1
fi

# frame pointers help perf/gdb/sanitizers unwind accurately on modern toolchains
fp_flags='-fno-omit-frame-pointer -mno-omit-leaf-frame-pointer'

# common sanitizer options for asan builds
asan_env='detect_leaks=1:halt_on_error=1:abort_on_error=1:malloc_context_size=30:fast_unwind_on_malloc=0:symbolize=1:strict_init_order=1:strict_string_checks=1:detect_stack_use_after_return=1:alloc_dealloc_mismatch=1:detect_container_overflow=1'
ubsan_env='print_stacktrace=1:report_error_type=1:halt_on_error=1'
lsan_env='print_suppressions=0:report_objects=1'

setup_sanitizer_env() {
  export ASAN_OPTIONS="$asan_env"
  export UBSAN_OPTIONS="$ubsan_env"
  export LSAN_OPTIONS="$lsan_env"

  if [[ -z "${ASAN_SYMBOLIZER_PATH:-}" ]] && command -v llvm-symbolizer >/dev/null 2>&1; then
    export ASAN_SYMBOLIZER_PATH
    ASAN_SYMBOLIZER_PATH="$(command -v llvm-symbolizer)"
  fi
}

cmake_build() {
  local cfg="$1"
  local builddir

  case "$cfg" in
    release)
      builddir=build-cmake-release
      rm -rf "$builddir"
      cmake -S . -B "$builddir" \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_C_COMPILER="$CC" \
        -DCMAKE_CXX_COMPILER="$CXX" \
        -DCMAKE_C_FLAGS_RELEASE="-O2 -march=native $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes" \
        -DCMAKE_CXX_FLAGS_RELEASE="-O2 -march=native $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      cmake --build "$builddir" -j"$NPROC"
      (cd "$builddir" && ctest --output-on-failure || true)
      ;;
    debug)
      builddir=build-cmake-debug
      rm -rf "$builddir"
      cmake -S . -B "$builddir" \
        -DCMAKE_BUILD_TYPE=Debug \
        -DCMAKE_C_COMPILER="$CC" \
        -DCMAKE_CXX_COMPILER="$CXX" \
        -DCMAKE_C_FLAGS_DEBUG="-g -O0 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes" \
        -DCMAKE_CXX_FLAGS_DEBUG="-g -O0 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      cmake --build "$builddir" -j"$NPROC"
      (cd "$builddir" && ctest --output-on-failure || true)
      ;;
    fastdebug)
      builddir=build-cmake-fastdebug
      rm -rf "$builddir"
      cmake -S . -B "$builddir" \
        -DCMAKE_BUILD_TYPE=RelWithDebInfo \
        -DCMAKE_C_COMPILER="$CC" \
        -DCMAKE_CXX_COMPILER="$CXX" \
        -DCMAKE_C_FLAGS_RELWITHDEBINFO="-O2 -march=native -g1 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes" \
        -DCMAKE_CXX_FLAGS_RELWITHDEBINFO="-O2 -march=native -g1 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      cmake --build "$builddir" -j"$NPROC"
      (cd "$builddir" && ctest --output-on-failure || true)
      ;;
    asan)
      builddir=build-cmake-asan
      rm -rf "$builddir"
      setup_sanitizer_env
      cmake -S . -B "$builddir" \
        -DCMAKE_BUILD_TYPE=Debug \
        -DCMAKE_C_COMPILER="$CC" \
        -DCMAKE_CXX_COMPILER="$CXX" \
        -DCMAKE_C_FLAGS_DEBUG="-g -O1 $fp_flags -Wall -Wextra -Wpedantic -fsanitize=address,undefined -fno-optimize-sibling-calls -Wno-unused-parameter -Wno-strict-prototypes" \
        -DCMAKE_CXX_FLAGS_DEBUG="-g -O1 $fp_flags -Wall -Wextra -Wpedantic -fsanitize=address,undefined -fno-optimize-sibling-calls -Wno-unused-parameter -Wno-strict-prototypes" \
        -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
        -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address,undefined"
      cmake --build "$builddir" -j"$NPROC"
      (cd "$builddir" && ctest --output-on-failure)
      ;;
    fastasan)
      builddir=build-cmake-fastasan
      rm -rf "$builddir"
      setup_sanitizer_env
      cmake -S . -B "$builddir" \
        -DCMAKE_BUILD_TYPE=RelWithDebInfo \
        -DCMAKE_C_COMPILER="$CC" \
        -DCMAKE_CXX_COMPILER="$CXX" \
        -DCMAKE_C_FLAGS_RELWITHDEBINFO="-O2 -march=native -g1 $fp_flags -fsanitize=address,undefined -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes" \
        -DCMAKE_CXX_FLAGS_RELWITHDEBINFO="-O2 -march=native -g1 $fp_flags -fsanitize=address,undefined -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes" \
        -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
        -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address,undefined"
      cmake --build "$builddir" -j"$NPROC"
      (cd "$builddir" && ctest --output-on-failure)
      ;;
    *)
      die "Unknown CMake config: $cfg"
      ;;
  esac
}

meson_build() {
  local cfg="$1"
  local builddir

  case "$cfg" in
    release)
      builddir=build-meson-release
      rm -rf "$builddir"
      meson setup "$builddir" . \
        --buildtype=release \
        -Dwarning_level=3 \
        -Dc_args="-O2 -march=native $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes" \
        -Dcpp_args="-O2 -march=native $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      meson compile -C "$builddir" -j"$NPROC"
      meson test -C "$builddir" --print-errorlogs || true
      ;;
    debug)
      builddir=build-meson-debug
      rm -rf "$builddir"
      meson setup "$builddir" . \
        --buildtype=debug \
        -Dwarning_level=3 \
        -Dc_args="-g -O0 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes" \
        -Dcpp_args="-g -O0 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      meson compile -C "$builddir" -j"$NPROC"
      meson test -C "$builddir" --print-errorlogs || true
      ;;
    fastdebug)
      builddir=build-meson-fastdebug
      rm -rf "$builddir"
      meson setup "$builddir" . \
        --buildtype=debugoptimized \
        -Dwarning_level=3 \
        -Dc_args="-O2 -march=native -g1 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes" \
        -Dcpp_args="-O2 -march=native -g1 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      meson compile -C "$builddir" -j"$NPROC"
      meson test -C "$builddir" --print-errorlogs || true
      ;;
    asan)
      builddir=build-meson-asan
      rm -rf "$builddir"
      setup_sanitizer_env
      meson setup "$builddir" . \
        --buildtype=debug \
        -Db_sanitize=address,undefined \
        -Db_lundef=false \
        -Dwarning_level=3 \
        -Dc_args="-g -O1 $fp_flags -Wall -Wextra -Wpedantic -fsanitize=address,undefined -fno-optimize-sibling-calls -Wno-unused-parameter -Wno-strict-prototypes" \
        -Dcpp_args="-g -O1 $fp_flags -Wall -Wextra -Wpedantic -fsanitize=address,undefined -fno-optimize-sibling-calls -Wno-unused-parameter -Wno-strict-prototypes"
      meson compile -C "$builddir" -j"$NPROC"
      meson test -C "$builddir" --print-errorlogs
      ;;
    fastasan)
      builddir=build-meson-fastasan
      rm -rf "$builddir"
      setup_sanitizer_env
      meson setup "$builddir" . \
        --buildtype=debugoptimized \
        -Db_sanitize=address,undefined \
        -Db_lundef=false \
        -Dwarning_level=3 \
        -Dc_args="-O2 -march=native -g1 $fp_flags -fsanitize=address,undefined -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes" \
        -Dcpp_args="-O2 -march=native -g1 $fp_flags -fsanitize=address,undefined -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      meson compile -C "$builddir" -j"$NPROC"
      meson test -C "$builddir" --print-errorlogs
      ;;
    *)
      die "Unknown Meson config: $cfg"
      ;;
  esac
}

autotools_prepare() {
  if [[ -x ./bootstrap ]]; then
    ./bootstrap
    return
  fi
  if [[ -x ./autogen.sh ]]; then
    ./autogen.sh
    return
  fi
  if [[ -f configure ]]; then
    return
  fi
  if [[ -f configure.ac || -f configure.in ]]; then
    command -v autoreconf >/dev/null 2>&1 || die "autoreconf not found but configure.ac exists"
    autoreconf -fi
    [[ -f configure ]] || die "autoreconf did not produce ./configure"
    return
  fi
  die "autotools requested but no bootstrap/autogen/configure/configure.ac found"
}

autotools_build() {
  local cfg="$1"
  local builddir
  local cflags
  local cxxflags
  local ldflags=""

  case "$cfg" in
    release)
      builddir=build-autotools-release
      cflags="-O2 -march=native $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      cxxflags="$cflags"
      ;;
    debug)
      builddir=build-autotools-debug
      cflags="-g -O0 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      cxxflags="$cflags"
      ;;
    fastdebug)
      builddir=build-autotools-fastdebug
      cflags="-O2 -march=native -g1 $fp_flags -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      cxxflags="$cflags"
      ;;
    asan)
      builddir=build-autotools-asan
      setup_sanitizer_env
      cflags="-g -O1 $fp_flags -Wall -Wextra -Wpedantic -fsanitize=address,undefined -fno-optimize-sibling-calls -Wno-unused-parameter -Wno-strict-prototypes"
      cxxflags="$cflags"
      ldflags="-fsanitize=address,undefined"
      ;;
    fastasan)
      builddir=build-autotools-fastasan
      setup_sanitizer_env
      cflags="-O2 -march=native -g1 $fp_flags -fsanitize=address,undefined -Wall -Wextra -Wpedantic -Wno-unused-parameter -Wno-strict-prototypes"
      cxxflags="$cflags"
      ldflags="-fsanitize=address,undefined"
      ;;
    *)
      die "Unknown Autotools config: $cfg"
      ;;
  esac

  autotools_prepare

  rm -rf "$builddir"
  mkdir -p "$builddir"

  (
    cd "$builddir"
    CFLAGS="$cflags" CXXFLAGS="$cxxflags" LDFLAGS="$ldflags" ../configure
    make -j"$NPROC"
    make check -j"$NPROC" || true
  )
}

case "$build_system" in
  cmake)     cmake_build "$config" ;;
  meson)     meson_build "$config" ;;
  autotools) autotools_build "$config" ;;
  *)         die "Internal error: unknown build system: $build_system" ;;
esac
