#!/bin/bash

usage() {
	echo "Usage: $0 [-d] <ebuild_directory>"
	echo "  -d  Dry run: show what would be done without making changes"
}

DRY_RUN=false

while getopts "dh" opt; do
	case ${opt} in
		d ) DRY_RUN=true ;;
		h ) usage; exit ;;
		\? ) usage; exit 1 ;;
	esac
done
shift $((OPTIND -1))

EBUILD_DIR="${1:-/var/db/repos/bp}"

BASE_DIR="/var/tmp/portage"

find "$BASE_DIR" -type d -name "work" | while read work_dir; do
	package_dir=$(dirname "$work_dir")
	package_name=$(basename "$package_dir" | sed 's/-[0-9].*//')

	source_dir=$(find "$work_dir" -mindepth 1 -maxdepth 1 -type d | head -n 1)
	if [[ -z "$source_dir" ]]; then
		echo "No source directory found under $work_dir, skipping..."
		continue
	fi

	actual_dir_name=$(basename "$source_dir")

	hyphen_count=$(grep -o "-" <<< "$actual_dir_name" | wc -l)

	if [ "$hyphen_count" -gt 1 ]; then
		actual_package_name=$(echo "$actual_dir_name" | rev | cut -d- -f2- | rev)
	else
		actual_package_name=$(echo "$actual_dir_name" | sed 's/-[^-]*$//')
	fi

	ebuild_file=$(find "$EBUILD_DIR" -type f -name "$package_name*.ebuild" | head -n 1)

	if [[ -z "$ebuild_file" ]]; then
		echo "Ebuild file for $package_name not found in $EBUILD_DIR, skipping..."
		continue
	fi

	if [[ "$DRY_RUN" = true ]]; then
		echo "Would set S in $ebuild_file to \"\${WORKDIR}/${actual_package_name}-\${SNAPSHOT}\""
	else
		echo "Setting S in $ebuild_file to \"\${WORKDIR}/${actual_package_name}-\${SNAPSHOT}\""
		sed -i "/^S=/c\S=\"\${WORKDIR}/${actual_package_name}-\${SNAPSHOT}\"" "$ebuild_file"
	fi
done
