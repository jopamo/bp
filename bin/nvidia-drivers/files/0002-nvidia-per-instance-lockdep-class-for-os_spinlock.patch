From acf2e371ba71a0a210a69f0fe74d5dfcdb907fdd Mon Sep 17 00:00:00 2001
From: Paul Moses <p@1g4.org>
Date: Wed, 18 Feb 2026 16:56:22 -0600
Subject: [PATCH] nvidia: set per-instance lockdep class for os_spinlock

---
 kernel-open/nvidia/os-interface.c | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)

diff --git a/kernel-open/nvidia/os-interface.c b/kernel-open/nvidia/os-interface.c
index 37cbbee5..965041a4 100644
--- a/kernel-open/nvidia/os-interface.c
+++ b/kernel-open/nvidia/os-interface.c
@@ -1284,6 +1284,15 @@ typedef struct os_spinlock_s
 {
     nv_spinlock_t      lock;
     unsigned long      eflags;
+
+#if defined(CONFIG_LOCKDEP)
+    /*
+     * Per-instance class key for dynamically allocated spinlocks.
+     * This avoids collapsing all os_spinlock_t instances into one
+     * lockdep class initialized at a single callsite.
+     */
+    struct lock_class_key key;
+#endif // CONFIG_LOCKDEP
 } os_spinlock_t;
 
 NV_STATUS NV_API_CALL os_alloc_spinlock(void **ppSpinlock)
@@ -1301,11 +1310,22 @@ NV_STATUS NV_API_CALL os_alloc_spinlock(void **ppSpinlock)
     os_spinlock = (os_spinlock_t *)*ppSpinlock;
     NV_SPIN_LOCK_INIT(&os_spinlock->lock);
     os_spinlock->eflags = 0;
+
+#if defined(CONFIG_LOCKDEP)
+    lockdep_register_key(&os_spinlock->key);
+    lockdep_set_class(&os_spinlock->lock, &os_spinlock->key);
+#endif // CONFIG_LOCKDEP
+
     return NV_OK;
 }
 
 void NV_API_CALL os_free_spinlock(void *pSpinlock)
 {
+#if defined(CONFIG_LOCKDEP)
+    os_spinlock_t *os_spinlock = (os_spinlock_t *)pSpinlock;
+    lockdep_unregister_key(&os_spinlock->key);
+#endif // CONFIG_LOCKDEP
+
     os_free_mem(pSpinlock);
 }
 
-- 
2.53.0

