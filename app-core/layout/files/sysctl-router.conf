# sysctl-router.conf
# Router-specific additions

##############################################################################
# NETWORK ROUTER (IPv4-only)
##############################################################################

# Enable IPv4 forwarding so the box can route between interfaces
net.ipv4.ip_forward = 1

# IPv6 forwarding is already disabled via sysctl-disable-ipv6.conf

##############################################################################
# IPv4 ROUTING SECURITY
##############################################################################

# Use loose reverse path filtering to support NAT and asymmetric routing
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2

# Do not accept or send ICMP redirects; disable secure redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Disable acceptance of source-routed packets
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Log packets with impossible or invalid source addresses
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

##############################################################################
# CONNECTION TRACKING (GAMING / VOIP FRIENDLY)
##############################################################################

# Maximum number of tracked connections
net.netfilter.nf_conntrack_max = 262144

# TCP state timeouts (in seconds)
net.netfilter.nf_conntrack_tcp_timeout_established = 86400
net.netfilter.nf_conntrack_tcp_timeout_close = 10

# Allow loose matching of TCP connections (helps NAT traversal)
net.netfilter.nf_conntrack_tcp_loose = 1

# Longer UDP timeouts for gaming, VoIP, and peer-to-peer
net.netfilter.nf_conntrack_udp_timeout        = 120
net.netfilter.nf_conntrack_udp_timeout_stream = 600

# Disable automatic connection tracking helpers (SIP, H323, etc.)
net.netfilter.nf_conntrack_helper = 0

##############################################################################
# TCP BEHAVIOR
##############################################################################

# Disable TCP Fast Open by default; can cause issues through some middleboxes
net.ipv4.tcp_fastopen = 0

# Enable MTU probing to avoid path MTU black holes when ICMP is filtered
net.ipv4.tcp_mtu_probing = 1

##############################################################################
# BPF / POLLING (PERFORMANCE)
##############################################################################

# Enable the BPF JIT compiler with hardening enabled
net.core.bpf_jit_enable = 1
net.core.bpf_jit_harden = 2

# Busy polling can reduce latency at the cost of extra CPU usage
net.core.busy_poll = 50
net.core.busy_read = 50

##############################################################################
# ICMP / ARP HYGIENE
##############################################################################

# Ignore broadcast ICMP echo requests
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore bogus ICMP error responses
net.ipv4.icmp_ignore_bogus_error_responses = 1

# ARP anti-flux settings to reduce address conflicts and spoofing
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2
net.ipv4.conf.default.arp_ignore = 1
net.ipv4.conf.default.arp_announce = 2

##############################################################################
# QUEUING AND ECN
##############################################################################

# Use fq_codel as the default queuing discipline for fair queuing and lower latency
net.core.default_qdisc = fq_codel

# Enable Explicit Congestion Notification if supported by your ISP
net.ipv4.tcp_ecn = 1
