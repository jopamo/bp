# /etc/nftables.conf
# Router firewall: dead silent on WAN, LAN-friendly for gaming/VoIP

# Flush all existing rules
flush ruleset

# -------------------------------------------------------------------
# Interface & network variables
# -------------------------------------------------------------------
define WAN       = "enp1s0"
define LAN       = "enp2s0"
define LAN_NET   = 10.0.5.0/24
define ROUTER_IP = 10.0.5.1
define LAN_BCAST = 255.255.255.255

# =============================== FILTER ===============================
table ip filter {

  # ---------------------------------------------------------------
  # INPUT: traffic to the router itself
  # ---------------------------------------------------------------
  chain input {
    type filter hook input priority 0; policy drop;

    # Allow return/related traffic
    ct state established,related accept comment "Allow established/related"

    # Sanity checks
    ct state invalid counter drop comment "Drop invalid"
    tcp flags & (syn|rst|ack) != syn ct state new drop comment "Drop NEW TCP without SYN"

    # Loopback
    iif lo accept comment "Allow loopback"

    # Silent to WAN
    iifname $WAN drop comment "Drop unsolicited WAN input (silent)"

    # DHCP from LAN
    iifname $LAN udp sport 68 udp dport 67 accept comment "Allow DHCP (LAN->router)"

    # Anti-spoof on LAN
    iifname $LAN ip saddr != $LAN_NET drop comment "Anti-spoof on LAN"

    # SSH from LAN (rate-limited)
    iifname $LAN ip saddr $LAN_NET tcp dport 22 ct state new tcp flags syn \
      limit rate 30/minute burst 10 packets accept comment "Allow SSH from LAN (limited)"

    # LAN -> router DNS
    iifname $LAN ip saddr $LAN_NET ip daddr $ROUTER_IP udp dport 53 accept comment "Allow LAN->DNS UDP"
    iifname $LAN ip saddr $LAN_NET ip daddr $ROUTER_IP tcp dport 53 accept comment "Allow LAN->DNS TCP"

    # Useful ICMP from LAN
    iifname $LAN ip saddr $LAN_NET icmp type { echo-request, destination-unreachable, time-exceeded, parameter-problem } \
      accept comment "Allow useful ICMP from LAN"

    # Broadcast helpers on LAN (rate-limited)
    iifname $LAN ip saddr $LAN_NET ip daddr $LAN_BCAST udp dport 54925 \
      limit rate 10/second accept comment "Allow Brother scanner discovery (limited)"
    iifname $LAN ip saddr $LAN_NET ip daddr $LAN_BCAST udp dport 137 \
      limit rate 10/second accept comment "Allow NetBIOS name service (limited)"

    # Block direct DoT to the router
    iifname $LAN tcp dport 853 drop comment "Block direct DoT TCP to router"
    iifname $LAN udp dport 853 drop comment "Block direct DoT UDP to router"

    # Catch-all: log (rate-limited) then drop
    counter log prefix "INPUT_DROP: " limit rate 5/second drop comment "Log+drop other input"
  }

  # ---------------------------------------------------------------
  # FORWARD: LAN <-> WAN through the router
  # ---------------------------------------------------------------
  chain forward {
    type filter hook forward priority 0; policy drop;

    # Sanity checks
    ct state invalid drop comment "Drop invalid"
    tcp flags & (syn|rst|ack) != syn ct state new drop comment "Drop NEW TCP without SYN"

    # Block LAN clients from using DoT externally
    iifname $LAN oifname $WAN udp dport 853 drop comment "Block LAN->Internet DoT UDP"
    iifname $LAN oifname $WAN tcp dport 853 drop comment "Block LAN->Internet DoT TCP"

    # Gaming/VoIP friendly: allow LAN->WAN
    iifname $LAN oifname $WAN accept comment "Allow LAN->WAN"

    # Allow return/related WAN->LAN
    iifname $WAN oifname $LAN ct state established,related accept comment "Allow WAN->LAN return/related"

    # Catch-all: log (rate-limited) then drop
    counter log prefix "FORWARD_DROP: " limit rate 5/second drop comment "Log+drop other forward"
  }

  # ---------------------------------------------------------------
  # OUTPUT: traffic from the router itself
  # ---------------------------------------------------------------
  chain output {
    type filter hook output priority 0; policy accept;
    # For strict egress control, change to drop + allowlist essentials (NTP, DoT, updates).
  }
}

# ================================ NAT ================================
table ip nat {

  chain prerouting {
    type nat hook prerouting priority -100;

    # Redirect all LAN DNS to routerâ€™s dnsmasq
    iifname $LAN udp dport 53 redirect to :53 comment "Redirect DNS UDP -> router"
    iifname $LAN tcp dport 53 redirect to :53 comment "Redirect DNS TCP -> router"
  }

  chain postrouting {
    type nat hook postrouting priority 100;

    # Masquerade all outbound traffic
    oifname $WAN masquerade comment "Masquerade outbound"
  }
}
