From d34df7271e16c6fdb7629c59e72c089cdcf4368b Mon Sep 17 00:00:00 2001
From: Paul Moses <p@1g4.org>
Date: Wed, 18 Feb 2026 16:54:43 -0600
Subject: [PATCH] nvidia-drm: retry colorspace reset on -EDEADLK

---
 kernel-open/nvidia-drm/nvidia-drm-drv.c | 27 ++++++++++++++++++-------
 1 file changed, 20 insertions(+), 7 deletions(-)

diff --git a/kernel-open/nvidia-drm/nvidia-drm-drv.c b/kernel-open/nvidia-drm/nvidia-drm-drv.c
index e9ef77c9..543eda04 100644
--- a/kernel-open/nvidia-drm/nvidia-drm-drv.c
+++ b/kernel-open/nvidia-drm/nvidia-drm-drv.c
@@ -934,24 +934,28 @@ int nv_drm_reset_input_colorspace(struct drm_device *dev)
     struct nv_drm_plane_state *nv_drm_plane_state;
     struct drm_modeset_acquire_ctx ctx;
     int ret = 0;
-    bool do_reset = false;
+    bool do_reset;
     NvU32 flags = 0;
 
-    state = drm_atomic_state_alloc(dev);
-    if (!state)
-        return -ENOMEM;
-
 #if defined(DRM_MODESET_ACQUIRE_INTERRUPTIBLE)
     flags |= DRM_MODESET_ACQUIRE_INTERRUPTIBLE;
 #endif
     drm_modeset_acquire_init(&ctx, flags);
+
+retry:
+    do_reset = false;
+    state = drm_atomic_state_alloc(dev);
+    if (!state) {
+        ret = -ENOMEM;
+        goto out;
+    }
     state->acquire_ctx = &ctx;
 
     nv_drm_for_each_plane(plane, dev) {
         plane_state = drm_atomic_get_plane_state(state, plane);
         if (IS_ERR(plane_state)) {
             ret = PTR_ERR(plane_state);
-            goto out;
+            goto put_state;
         }
 
         nv_drm_plane_state = to_nv_drm_plane_state(plane_state);
@@ -967,8 +971,17 @@ int nv_drm_reset_input_colorspace(struct drm_device *dev)
         ret = drm_atomic_commit(state);
     }
 
-out:
+put_state:
     drm_atomic_state_put(state);
+
+    if (ret == -EDEADLK) {
+        ret = drm_modeset_backoff(&ctx);
+        if (!ret) {
+            goto retry;
+        }
+    }
+
+out:
     drm_modeset_drop_locks(&ctx);
     drm_modeset_acquire_fini(&ctx);
 
-- 
2.53.0

