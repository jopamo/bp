# app-core/layout/files/sysctl-hardening.conf
# sysctl-hardening.conf
# base host-safe hardening for desktops, laptops, and servers

##############################################################################
# FILE DESCRIPTORS AND INOTIFY LIMITS
##############################################################################

# maximum number of open file descriptors system-wide
fs.file-max = 100000

# inotify instance and watch limits for desktop usability and IDEs
fs.inotify.max_user_instances = 2048
fs.inotify.max_user_watches   = 1048576

##############################################################################
# FILE AND PROCESS HARDENING
##############################################################################

# protect against symlink and hardlink attacks in world-writable directories
fs.protected_symlinks = 1
fs.protected_hardlinks = 1

# protect FIFO and regular files in world-writable directories
fs.protected_fifos = 2
fs.protected_regular = 2

# do not allow setuid binaries to produce core dumps
fs.suid_dumpable = 0

##############################################################################
# CORE DUMPS, CRASH HANDLING, AND KERNEL VISIBILITY
##############################################################################

# include pid in core dump file names
kernel.core_uses_pid = 1

# restrict dmesg access to root only
kernel.dmesg_restrict = 1

# disable kexec syscall to prevent loading arbitrary kernels
kernel.kexec_load_disabled = 1

# restrict exposure of kernel pointers
kernel.kptr_restrict = 2

# limit oops and warnings to avoid log floods
kernel.oops_limit = 100
kernel.warn_limit = 100

# disable magic SysRq by default on user hosts
kernel.sysrq = 0

# disable unprivileged eBPF
kernel.unprivileged_bpf_disabled = 1

# enable full ASLR
kernel.randomize_va_space = 2

# restrict perf while keeping it usable for root
kernel.perf_event_paranoid = 2

# ptrace scope tightened but still developer friendly
kernel.yama.ptrace_scope = 1

# minimum mappable virtual memory address
vm.mmap_min_addr = 65536

# extra entropy for ASLR
vm.mmap_rnd_bits = 32
vm.mmap_rnd_compat_bits = 16

# disable unprivileged userfaultfd
vm.unprivileged_userfaultfd = 0

##############################################################################
# BPF AND TTY HARDENING
##############################################################################

# harden BPF JIT
net.core.bpf_jit_harden = 2

# prevent autoloading of TTY line disciplines
dev.tty.ldisc_autoload = 0

# disable legacy TIOCSTI ioctl
dev.tty.legacy_tiocsti = 0

##############################################################################
# NETWORKING: HOST POSTURE
##############################################################################

# disable forwarding on general hosts
net.ipv4.ip_forward = 0

# disable IPv6 forwarding on general hosts
net.ipv6.conf.all.forwarding = 0
net.ipv6.conf.default.forwarding = 0

##############################################################################
# NETWORKING: ICMP, ARP, AND ROUTING HYGIENE (IPv4)
##############################################################################

# ignore ICMP echo requests to broadcast addresses
net.ipv4.icmp_echo_ignore_broadcasts = 1

# ignore bogus ICMP error responses
net.ipv4.icmp_ignore_bogus_error_responses = 1

# enable RFC1337 protection against TIME-WAIT assassination
net.ipv4.tcp_rfc1337 = 1

# ARP hygiene
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2
net.ipv4.conf.default.arp_ignore = 1
net.ipv4.conf.default.arp_announce = 2

# reverse path filtering loose by default to play well with VPNs
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2

# do not accept or send redirects and disable secure redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# log martians
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

##############################################################################
# TCP PERFORMANCE AND HARDENING
##############################################################################

# timestamps for PAWS and RTT estimation
net.ipv4.tcp_timestamps = 1

# raise challenge ACK rate
net.ipv4.tcp_challenge_ack_limit = 100000

# modern ephemeral port range
net.ipv4.ip_local_port_range = 49152 65535

# conservative but responsive timers
net.ipv4.tcp_fin_timeout = 20
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_synack_retries = 3
net.ipv4.tcp_syncookies = 1

# enable MTU probing to avoid black holes
net.ipv4.tcp_mtu_probing = 1

##############################################################################
# QUEUES AND BUFFERS
##############################################################################

# default qdisc to fq_codel
net.core.default_qdisc = fq_codel

# backlog and buffer sizing
net.core.netdev_max_backlog = 32768
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.core.somaxconn = 1024
